---
title: Lavarel - 後台管理系統 02.
date: 2024-06-05 09:06:30
tags: 
    - 職訓
    - Lavarel
categories: 
    - [職訓, Lavarel]
    - Lavarel
description: 刪除功能及帳號驗證功能製作
---

#### 上半場

##### 全部勾選功能

> 這邊用的是jQuery，要記得```<scritp>```引入


1. 至`app.blade` 增加刪除語法，在```</head>```前
 
    ```php app.blade
    <script>
        $(document).ready(function() {
        $("#all").click(function(){
            if ($(this).is(":checked")){
            // .:代表class
            // attr: 屬性
            // 當id為all的checkbox被選取時, 所有的class為chk的都被選取
            // 用class而非id是因為不知道有多少選項會被選取, 被選取數可能會有所增減, 無法得知所有id
            $(".chk").attr("checked",true);
            }else{
            $("chk").attr("checked",false);
            }
        })
        });
    </script>
    ```
  
2. 由於要選取的是`.chk`的class，因此到`list.blade`的`cheakbox`加上這個class名稱  

    ```php list.blade
    <tr>
        <td class="col-1 text-center">
            <input type="checkbox" name="id[]" class="form-check-input chk" value="{{ $data->id }}"> 
            // 在以上那行的class
        </td>
        <td class="col-9 text-left">{{ $data->title }}</td>
        <td class="col-9 text-left">
            <a href="edit/{{ $data -> id }}" class="btn btn-success text-white">修改</a>
        </td>
    </tr>
    ```
  
---  
 
##### 刪除功能

1. 在list.blade裡新增```<form id="list" name="list" method="post" action="/admin/notice/delete">```  
   把```<table></table>```包起來, line.19
   並增加token `{{ csrf_field() }}`

    ```php list.blade
    <form id="list" name="list" method="post" action="/notice/delete">
            {{ csrf_field() }}
        <table class="table table-border border border-dark">
            <thead>
                <tr class="table table-warning">
                    <th class="col-1 text-center" style="vertical-align: middle;">
                        <input type="checkbox" class="form-check-input" id="all">
                    </th>
                    <th class="col-9 text-center">注意事項</th>
                    <th class="col-2text-center">修改</th>
                </tr>
            </thead>
            <tbody>
                @foreach($list as $data)
                <tr>
                    <td class="col-1 text-center">
                        <input type="checkbox" name="id[]" class="form-check-input chk" value="{{ $data->id }}">
                    </td>
                    <td class="col-9 text-left">{{ $data->title }}</td>
                    <td class="col-9 text-left">
                        <a href="edit/{{ $data -> id }}" class="btn btn-success text-white">修改</a>
                    </td>
                </tr>
                @endforeach
            </tbody>
        </table>
    </form>
    ```

2. 至app.blade新增```<script>```

    ```php app.blade
    function doDelete(formName){
        if(confirm("確定刪除？")){
        //document.list.submit();   第一個方法，不用給引數formName，不過只能選id:list的表單
        // list那邊也要改(拿掉引述)
        document.forms[formName].submit();    // 第二個方法，用引述自訂要選取的表單
        }
    }
    ```

3. 至 `model/Notice.php` 增加方法

     寫來讓`SQL`跑的
    用來分工用，寫在`model`讓需要使用時能直接抓取
    > 前面的其他功能也可以寫進`model`

    ```php model/Notice.php
    public function deleteNotice($ids)
        {
            self::wherein("id", $ids)->delete();
        }
    ```

4. 至 `AdminNoticeController.php` 增加方法

    ```php AdminNoticeController.php
    public function delete(Request $req){
        (new Notice())->deleteNotice($req->id);

        Session::flash("message", "已刪除");
        return redirect("/admin/notice/list");
    }
    ```

    測試應該可以動了！
  
---

##### 帳號密碼及認證碼驗證功能

1. 安裝外掛就能實現ㄌ

    ```terminal Terminal
    composer require mews/captcha
    ```

    總之給他裝下去就對ㄌ  

2. 新增跳轉頁面

    ```php Controllers/AdminController.php

    public function login(){
        return view("admin.login"); 
    }
    ```

3. 新增Login頁面
  
    在這個路徑下 `resources\views\admin\login.blade.php`
  
    ```php admin\login.blade.php
    
    <!DOCTYPE html>
    <html lang="zh-TW">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>管理系統登入</title>
        <link rel="stylesheet" href="/css/bootstrap.css">
        <link rel="stylesheet" href="/css/admin/sweetalert2.min.css">
        <script rel="stylesheet" src="/js/admin/sweetalert2.all.min.js"></script>
        <script src="/js/jquery.js"></script>
    </head>

    <body>
        <div class="container mt-4">
            <div class="card">
                <form method="post" action="admin/doLogin">
                    {{ csrf_field() }}
                    <div class="row mt-3">
                        <div class="col-2 text-center">帳號</div>
                        <div class="col-4">
                            <input type="text" name="userId" class="form-control" required value="{{old('userId')}}">
                        </div>
                        <div class="row mt-3">
                            <div class="col-2 text-center">密碼</div>
                            <div class="col-4">
                                <input type="password" name="pwd" class="form-control" required value="{{old('pwd')}}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-2 text-center">認證碼</div>
                            <div class="col-4">
                                <input type="password" name="code" class="form-control" required value="{{old('code')}}">
                            </div>
                            <div class="col-4 ms-2">
                                <!-- <img src="/captcha/math?">     驗證碼為數學題-->
                                <img src="/captcha/flat?">      <!-- 驗證碼為輸入文字 -->
                            </div>
                        </div>
                        <div class="row mt-3 text-end mb-3">
                            <div class="col-2">
                                <button type="submit" class="btn btn-primary btn-lg">登入</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </body>

    </html>

    ```

4. 可以適當調整驗證碼

   > `vander/mews/captcha/config/`
   剛才安裝的外掛路徑
  
5. phpMyAdmin

    > 新增資料表"`manager`"
    > 新增一組帳號密碼

    | id      | 帳號  | 密碼   |
    | ------- | ----- | ------ |
    | primary | admin | 123456 |

6. 增加路由

    ```php AdminController.php
    Route::group(["prefix" => "admin"], function(){
    Route::get("/",[AdminController::class, "login"]);
    Route::post("doLogin",[AdminController::class, "doLogin"]);     // 增加這條
    Route::get("home",[AdminController::class, "home"]);
    });
    ```

7. 增加方法讓doLogin出現帳號或密碼打錯的提示訊息

    ```php AdminController.php
    public function doLogin(Request $req){
        $manager = (new Manager())->getManager($req->userId, $req->pwd);
        if (empty($manager)){
            // back: 回到前一頁
            // withInput: 保留前一輸入資料
            // withErrors: 回傳錯誤訊息到前一頁
            return back()->withInput()->withErrors(["msg" => "帳號或密碼錯誤"]);
        }else{
            // 帳密符合, 轉址
            return redirect("/admin/home");
        }
    }
    ```
8. login.blade頁面增加msg顯示的div

    一般來說在帳號下面

    ```php login.blade
    @if ($errors->has('msg'))
    <div class="row">
        <div class="col-8 text-danger text-center">{{ $errors->first("msg") }}</div>
    </div>
    @endif
    ```

9. 增加方法讓doLogin出現驗證碼打錯的提示訊息

    ```php AdminController.php
    public function doLogin(Request $req){

        // 新增if判斷式
        if(captcha_check($req->code) == false){
            return back()->withInput()->withErrors(["code" => "驗證碼錯誤"]);
            exit;
        }


        $manager = (new Manager())->getManager($req->userId, $req->pwd);
        if (empty($manager)){
            // back: 回到前一頁
            // withInput: 保留前一輸入資料
            // withErrors: 回傳錯誤訊息到前一頁
            return back()->withInput()->withErrors(["msg" => "帳號或密碼錯誤"]);
        }else{
            // 帳密符合, 轉址
            return redirect("/admin/home");
        }
    }
    ```
10. login.blade頁面增加msg顯示的div

    放在驗證碼下面
    其實都可以啦看要在哪裡顯示自己調位置

    ```php login.blade
    @if ($errors->has('code'))      //記得改成 'code'
    <div class="row">
        <div class="col-8 text-danger text-center">{{ $errors->first("msg") }}</div>
    </div>
    @endif
    ```


    到這邊可以跑網頁輸入帳號密碼及驗證碼
    如果錯誤，送出後會跑出錯誤訊息
    ![](01.jpg)

    這樣就成功啦！

---

#### 下半場

##### 加入middleware驗證功能

1. 新增Session暫存資料, 讓伺服器記住已經成功登入過的資料  

    ```php AdminController.php
        public function doLogin(Request $req){

            if(captcha_check($req->code) == false){
                return back()->withInput()->withErrors(["code" => "驗證碼錯誤"]);
                exit;
            }

            $manager = (new Manager())->getManager($req->userId, $req->pwd);
            if (empty($manager)){
                // back: 回到前一頁
                // withInput: 保留前一輸入資料
                // withErrors: 回傳錯誤訊息到前一頁
                return back()->withInput()->withErrors(["msg" => "帳號或密碼錯誤"]);
            }else{
                // session: 存在伺服器端的站存資料, 記住已經登入過的人
                // 超過config設定的時間會自動清除
                session()->put("managerId",$req->userId);           // 新增這段
                // 帳密符合, 轉址
                return redirect("/admin/home");
            }
        }
    ```

2. 新增middleware設定檔

    ```terminal Terminal
        php artisan make:middleware CheckManager
    ```

3. 到剛才新增的`Middleware\CheckManager.php`新增方法

    ```php app\Http\Middleware\CheckManager.php
    public function handle(Request $request, Closure $next)
    {
        if (empty(session()->get("managerId"))){
            return redirect("/admin");
            exit;
        }
        return $next($request);
    }
    ```
4. 到`app\Http\Kernel.php`登入`CheckManager`的路由

    ```php app\Http\Kernel.php
    protected $routeMiddleware = [
        'auth' => \App\Http\Middleware\Authenticate::class,
        'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'cache.headers' => \Illuminate\Http\Middleware\SetCacheHeaders::class,
        'can' => \Illuminate\Auth\Middleware\Authorize::class,
        'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
        'password.confirm' => \Illuminate\Auth\Middleware\RequirePassword::class,
        'signed' => \Illuminate\Routing\Middleware\ValidateSignature::class,
        'throttle' => \Illuminate\Routing\Middleware\ThrottleRequests::class,
        'verified' => \Illuminate\Auth\Middleware\EnsureEmailIsVerified::class,
        "manager" => \App\Http\Middleware\CheckManager::class,
        // 新增上排, 順便替這個Middleware取別名叫manager
    ];
    ```
5. 到`web`修改路由，讓跳轉時可以經過`middleware`

    ```php routes\web.php
    Route::group(["prefix" => "admin"], function(){
        Route::get("/",[AdminController::class, "login"]);
        Route::post("doLogin",[AdminController::class, "doLogin"]);
        Route::get("home",[AdminController::class, "home"])->middleware("manager");
                                                            // 只在單獨的路由新增, 代表只有執行這個路由時經過驗證
    });

    
    // group內新增 "middleware"=>"manager", 代表整個group都會經過middleware
    Route::group(["middleware"=>"manager","prefix" => "admin/notice"], function(){
        Route::get("list",[AdminNoticeController::class, "list"]);
        Route::get("add",[AdminNoticeController::class, "add"]);
        Route::post("insert",[AdminNoticeController::class, "insert"]);
        Route::get("edit/{id}",[AdminNoticeController::class, "edit"]);
        Route::post("update",[AdminNoticeController::class, "update"]);
        Route::post("delete",[AdminNoticeController::class, "delete"]);

    });
    ```

完成後只要沒有成功登入，就算輸入路徑也無法跳轉，會回到`Login`登入頁面
如果有成功登入，在config設定的Session暫存時間內都可以不用再登入直接進入`home page`
  

#### 參考資料

> [[技術探討]jQuery小而精的網頁函式庫 (一)](https://blog.ite2.com/jquery01/)
> [jQuery JavsScript函式庫](https://hackmd.io/@roroiii/HJTXY8Wg8)
> [MIS2000Lab.的「HTML5 認證考試，從零開始」#10--寫得少，做得多。jQuery簡介(I)](https://ithelp.ithome.com.tw/m/articles/10158237)
>> ↑這篇在運作模式上寫的滿清楚的
