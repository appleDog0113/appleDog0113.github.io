---
title: Laravel-後台管理系統與前台顯示 04
date: 2024-06-19 08:25:22
tags: 
    - 職訓
    - Laravel
categories: 
    - [職訓, Laravel]
    - Laravel
description: 商品簡介頁面製作
---

##### 上半場

1. admin/pro上傳圖片

```php app\Http\Controllers\Admin\AdminProductController.php
public function insert(Request $req){
    
    $photo = $req->photo;
    $times = explode(" ", microtime());     //將microtime分割成陣列
    $fileName = $times[1].".".$photo->extension();     // extension()->副檔名
    $photo->move("images/product", $fileName);      // 在public資料夾下新增

    $product = new Product();
    $product->title = $req->title;
    $product->photo = $fileName;
    $product->save();

    Session::flash("message","已新增");
    return redirect("/admin/product/list");
}
```

{% note info %}

要先新增`/public/image` 資料夾，讓上傳的檔案可以統一放在公開資料夾裡（/public下所有東西的權限都是公開的）
前面`microtime()`是抓後面的毫秒數當圖檔的檔名
可以`console.log`出`microtime()`觀察長什麼樣子

+ 將資料夾命名的時間轉換成 `YYMMDD` 的魔法

    ```php
    $times = explode(" ", microtime());
    $time = strftime("%Y%m%D%H%M%S", $times[1]);
    ```

  + 通常不能只取到秒，至少要取到微秒，才不會有同時上傳檔案名稱相同的問題

+ 取微秒中的前三碼
  + 代表每秒可以同時上傳1000個檔案

    ```php
    $time .= "_".substr($times[0],2,3);
    ```

  + `substr();`: 取字串
  + `$time[0]` : 例如 0.123456789
  `substr($times[0],2 ,6)`: 從`$time[0]`取字串，`2`: 表示從第三個字開始（索引值從0開始），`6`: 表示取6個字
  + `.=` 表示左邊與右邊相接

{% endnote %}

2. 修改已上傳內容

```php app\Http\Controllers\Admin\AdminProductController.php

public function edit(Request $req){
    $pro = Product::find($req->id);
    return view("admin.product.edit",compact("pro"));
}

    public function update(Request $req){

        $photo = $req->photo;
        $pro = Product::find($req->id);
        
        if(!empty($photo)){
            @unlink("images/product/" . $pro->photo);
            $times = explode(" ", microtime());
            $fileName = $times[1].".".$photo->extension();
            $photo->move("images/product", $fileName);
            $pro->photo = $fileName;
        }

        $pro->title = $req->title;
        $pro->update();

        Session::flash("message", "已修改");
        return redirect("/admin/product/list");
    }

```

{% note info %}

+ 先載入圖片和db的內容

    ```php
    $photo = $req->photo;
    $pro = Product::find($req->id);
    ```

+ 然後下判斷式看`photo`是否有東西（是否修改圖片）
非為空就先從`路徑刪除原圖片`，再新增

    ```php 使用php語法從路徑刪除$pro->photo同名檔案
    @unlink("images/product/" . $pro->photo);
    ```

+ 將`photo`和`title`分開判斷
  是為了只更新`title`時`photo`不用更新
  + 更新`photo`時先把原本的圖片刪掉
  不然原本的圖片會依然存在不會被覆蓋，圖片檔會變超~級~多~

{% endnote %}

3. 修改view讓圖片更新可以顯示原本的圖片

```php resources\views\admin\product\edit.blade.php
<label class="col-form-lable col-3 text-right">產品圖片</label>
<div class="col-9">
    <input type="file" class="form-control" name="photo">
    @if (!empty($pro->photo))
    <div class="mt-3"><img src="/images/product/{{ $pro->photo }}" alt="" width="150"></div>
    @endif
</div>
```

{% note info %}

`<form>` 要設定為可上傳檔案
> `enctype="multipart/form-data"`

{% endnote %}

4. 上傳圖片尺寸設定

{% note danger %}

如果檔案無法上傳記得到php server去改`upload filesize`跟`max post size`
重開php server 和 Laravel server就可以了
記得要確認`使用版本`、`啟動版本`、修改的`php.ini檔版本`是否相同

{% endnote %}

5. 刪除功能

```php app\Http\Controllers\Admin\AdminProductController.php
public function delete(Request $req){

    $id = $req->id;
    if(!empty($id)){
        foreach($id as $data){
            $pro = Product::find($data);
            if(!empty($pro->photo)){
                @unlink("images/product/" . $pro->photo);
            }
            $pro->delete();
        }
    }

    Session::flash("message", "已刪除");
    return redirect("/admin/product/list");
}
```

{% note info %}

用`$id`抓`db`內容
主要是有`圖片刪除`的部分
要從路徑刪除圖檔，使用`@unlink()`

{% endnote %}

6. 分頁寫在`Model`裡
   本來是寫在`Controller`，現在改放到`Model`

   ```php 寫法一
       public function getProduct(){
        $list = self::paginate(10);

        return $list;        
    }
    ```

    {% note info %}
    **寫法一 說明**
    self: 指的是物件本身, 也就是product資料表
    paginate(10): 每10筆為一頁
    {% endnote %}

    ```php 寫法二
    public function getList(){

        $list = DB::table("product")->paginate(10);
        return $list;       
        
    }
    ```

    {% note info %}
    **寫法二 說明**
    從product資料表裡取資料，每10筆一頁
    其實跟上面的寫法一樣
    DB是`Http/config/app.php`裡預設的寫法，可以直接指向預先設定好的資料庫
    {% endnote %}

7. 處理前台
   總之先把Controller和Route連上
   pro.blode先基本繼承好

    ```php
    @extends("front.layout")
    @section("content")
    <h2 class="text-center title mb-5 mt-lg-5">產品介紹</h2>
    <div class="col-xxl-10 col-lg-11 col-sm-11 col-xs-12 mx-auto">
    <div class="gw  mb-lg-5">
        <div class="css-dropdown">
        <input type="checkbox" id="drop" hidden>
        <label for="drop"></label>
        <div class="inner">
            @if(!empty($list) && sizeof($list)>0)
            @php $cnt = 0; @endphp
            @foreach($list as $data)
            @php $cnt++; @endphp
                @if($cnt == 1)
                <a href="#" class="active">產品{{$data->title}}</a>
                @else
                <a href="#">產品{{$data->title}}</a>
                @endif
            @endforeach
            @endif
        </div><!--inner-->
        </div><!--css-dropdown-->
    </div><!--w-100-->
    <div class="gw img-size-50 text-center pb-5">
        @if(!empty($data->photo))
        <img src="/images/product/{{ $data->photo }}" alt="">
        @endif
    </div><!--img-wrap-->
    </div><!--col-->
    @endsection
    ```

