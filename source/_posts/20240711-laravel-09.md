---
title: "Laravel-09-專案二: 賣茶網"
date: 2024-07-11 08:32:48
tags:
  - 職訓
  - Laravel
categories:
  - [職訓, Laravel]
  - Laravel
description: "後台news頁面上傳圖片欄位製作、加入lightbox效果、製作news前台頁面"
---

### 製作最新消息頁面

#### 後台news頁面製作

##### NewsController新增上傳圖片需使用的方法

```php app\Http\Controllers\Admin\News\NewsController.php
public function insert(Request $req)
{
    $photo = $req->photo;
    $times = explode(" ", microtime());
    $fileName = $times[1] . "." . $photo->extension();

    if (!file_exists("images")) {
        mkdir("images", 0777);
    }

    if (!file_exists("images/news")) {
        mkdir("images/news", 0777);
    }

    $photo->move("images/news", $fileName);

    $news = new News();
    $news->typeId = $req->typeId;
    $news->title = $req->title;
    $news->subtitle = $req->subtitle;
    $news->dates = $req->dates;
    $news->content = $req->content;
    $news->photo = $fileName;
    $news->save();

    Session::flash("message", "已新增");
    return redirect("admin/news/list");
}
```

{% note info %}

```php 處理上傳圖片
$photo = $req->photo;
$times = explode(" ", microtime());
$fileName = $times[1] . "." . $photo->extension();

if (!file_exists("images")) {
    mkdir("images", 0777);
}

if (!file_exists("images/news")) {
    mkdir("images/news", 0777);
}

$photo->move("images/news", $fileName);
```

1. 準備將上傳的圖片檔名重設為毫秒 `$times = explode(" ", microtime());`, `$fileName = $times[1] . "." . $photo->extension();`
2. 新建資料夾路徑，賦予權限777（其實可以不用開這麼大）
3. 將圖片移動到新資料夾，賦予新檔名`$fileName`
4. `$news->photo = $fileName;` 將資料庫圖片內容設為`$filename`，避免存入暫存檔

{% endnote %}

##### 新增頁面edit.blade

複製add.blade的修改就行了

```php resources\views\admin\news\edit.blade.php
@extends("admin.app")
@section("title","修改最新消息")
@section("content")
<link rel="stylesheet" href="/css/admin/ckeditor.css">

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <a href="../list" class="btn btn-info">回上頁</a>
            </div>
            <div class="card-body">
                <form method="post" action="../update" enctype="multipart/form-data">
                    <input type="hidden" name="id" value="{{ $news->id}}">
                    {{ csrf_field() }}
                    <div class="row mt-3">
                        <label class="col-2 text-end form-label">類別</label>
                        <div class="col-2">
                            <select name="typeId" id="typeId" class="form-control text-center" required>
                                <option value="" disabled>---請選擇類別---</option>
                                @foreach($list as $data)
                                <option value="{{ $data->id }}" {{ $data->id == $news->typeId ?  " selected" : ""}}>{{ $data->title }}</option>
                                @endforeach
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <label class="col-2 text-end form-label">標題</label>
                        <div class="col-6">
                            <input type="text" class="form-control" name="title" id="title" value="{{$news->title}}" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <label class="col-2 text-end form-label">次標題</label>
                        <div class="col-6">
                            <input type="text" class="form-control" name="subtitle" id="subtitle" value="{{$news->subtitle}}" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <label class="col-2 text-end form-label">日期</label>
                        <div class="col-2">
                            <input type="date" class="form-control" name="dates" id="dates" value="{{$news->dates}}" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <label class="col-2 text-end form-label">內容</label>
                        <div class="col-6">
                            <textarea class="form-control editor" name="content" id="editor">{!! $news->content !!}</textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <label class="col-2 text-end form-label">圖檔</label>
                        <div class="col-6">
                            <input type="file" class="form-control mb-3" name="photo" id="photo">
                            @if(!empty($news->photo))
                            <img src="/images/news/{{ $news->photo }}" width="250">
                            @endif
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-10 text-center">
                            <button type="submit" class="btn btn-primary">儲存</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/super-build/ckeditor.js"></script>
<script src="/js/admin/editor.js"></script>
@endsection
```

{% note info %}

整理筆記的時候大部分內容都已經完成了，
這邊逐項簡單說明

1. 圖檔input的位置新增預覽既有圖片的欄位

```php
@if(!empty($news->photo))
<img src="/images/news/{{ $news->photo }}" width="250">
@endif
```

2. `<form method="post" action="../update" enctype="multipart/form-data">`
`action`後的連結改為相對路徑，網頁進入的層數才不會多一層

3. 所有`<input>`加上`value="{{$news->(該項目id)}}"`，讓後端讀取並顯示既有資料
`content`的部分用html方式渲染，`code`要改為`{!! $news->content !!}`

{% endnote %}

##### NewsController新增方法 edit、update

```php
public function edit(Request $req)
{
    $news = News::find($req->id);
    $list = NewsType::get();
    return view("admin.news.edit", compact("news","list"));
}

public function update(Request $req)
{
    $photo = $req->photo;
    $news = News::find($req->id);

    if (!empty($photo)) {
        @unlink("images/news/" . $news->photo);
        $times = explode(" ", microtime());
        $fileName = $times[1] . "." . $photo->extension();
        $photo->move("images/news", $fileName);
        $news->photo = $fileName;
    }

    $news->typeId = $req->typeId;
    $news->title = $req->title;
    $news->subtitle = $req->subtitle;
    $news->dates = $req->dates;
    $news->content = $req->content;
    $news->update();

    Session::flash("message", "已修改");
    return redirect("/admin/news/list");
}
```

{% note info %}

修改圖片時要把原資料夾圖片刪除，用新增的圖片取代
~~未來工作可以把所有圖片保留，以避免各種意外~~

```php 修改圖片時將資料夾內的圖片刪除並上傳新圖片
if (!empty($photo)) {
    @unlink("images/news/" . $news->photo);
    $times = explode(" ", microtime());
    $fileName = $times[1] . "." . $photo->extension();
    $photo->move("images/news", $fileName);
    $news->photo = $fileName;
}
```

{% endnote %}

##### list.blade頁面增加圖片lightbox效果

   1. `<body>`最開頭引入相關`css`和`js`

        ```php
        <link rel="stylesheet" href="/css/lightbox.min.css">
        <script src="/js/lightbox.min.js"></script>
        ```

   2. 圖片顯示的位置加入`<a href>`，新增屬性`data-lightbox="photo"`
   完整版:`<a href="/images/news/{{ $data->photo }}" data-lightbox="photo">`

##### 刪除功能製作

新增方法，大家都懂ㄉ

```php app\Http\Controllers\Admin\News\NewsController.php
public function delete(Request $req)
{
    // (new News())->delItem($req->id);

    $ids = $req->id;
    foreach ($ids as $id){
        $news = News::find($id);
        if(!empty($news->photo)){
            @unlink("images/news/" . $news->photo);
        }

        $news->delete();
    }


    Session::flash("message", "已刪除");
    return redirect("/admin/news/list");
}
```

##### 突然想到把時區修改成亞洲台北

```php config\app.php
'timezone' => 'Asia/Taipei',
```

---

#### 製作前台news頁面

##### css檔案搬移

1. 在`/public/css` 底下新增資料夾`/news`
完整路徑：`public\css\news`

2. 將原始檔裡的兩個css檔複製過去
這邊是`news_detail.css`和`tab.css`

##### 製作年份及類別篩選文章功能

網頁上有用年份和類別篩選的功能，在`Model/news`新增兩支方法實作

```php app\Models\News\News.php
public function getYearList(){
    // distinct(): 去除重複資料取唯一值
    $list = self::selectRaw("YEAR(dates) AS year")->distinct()->get();
    return $list;
}

public function getDataList($year, $typeId){

    // 尚未選年份或類別前, where 1=1 一定成立，即表示全部
    //  如果有選年分
    $sql = DB::table("news");

    if(!empty($year)){

        // 查詢條件加上年分
        // whereYear = select * from news where YEAR(dates) = 年
        $sql->whereYear("dates", $year);
    }

    // 如果有選類別
    if(!empty($typeId)){
        $sql->where("typeId", $typeId);
    }

    // 將查詢條件依日期新舊排列, 並設定給list
    $list = $sql->orderby("dates","DESC")->get();
    return $list;
}
```

##### 新增前台FrontNewsController

```Terminal
php artisan make:controller Front/FrontNewsController
```

##### 新增方法

```php app\Http\Controllers\Front\FrontNewsController.php

public function list(Request $req){
    // 取得消息類別
    $types = NewsType::get();

    // 取得年份
    $year = (new News())->getYearList();

    return view("front.news.list", compact("types", "year"));

}

public function getNews(Request $req){

    // 取得所有最新消息
    $list = (new News())->getDataList($req->year, $req->typeId);
    return view("front.news.news", compact("list"));
}

public function detail(Request $req){
    $news = News::find($req->id);

    return view("front.news.detail", compact("news"));
}

```

##### Route串接

沒時間了剩一點有空繼續做